--Primero corregir la tabla de colaboración (PORQUE ESTABA MAL)
--Borrar todos lo registros de la tabla y ejecutar estos comandos (que ya tiene los datos corregidos)
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (1,	1);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (2,	2);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (3,	3);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (4,	4);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (5,	5);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (6,	6);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (7,	7);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (8,	8);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (9,	9);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (10,	10);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (11,	11);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (12,	12);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (13,	13);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (14,	14);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (15,	15);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (16,	16);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (17,	17);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (18,	18);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (19,	19);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (20,	20);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (21,	21);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (22,	22);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (23,	23);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (24,	24);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (25,	25);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (26,	26);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (27,	27);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (28,	28);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (29,	29);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (30,	30);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (21,   31);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (31,	32);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (32,	33);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (33,	34);
INSERT INTO USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) VALUES (34,	35);

--Ahora si, crear los siguientes procedimientos

--PROCEDIMIENTO QUE ABRE LA VISTA DE LOS LIBROS (PARA QUE SE MUESTRE EN EL GRIBVIEW)
Create or replace procedure Vista_libros (registros out sys_refcursor)
as
Begin
    open registros for select * from VI_Libros;
End;
--
--CREA UNA VISTA PARA PRESENTAR LOS DATOS DEL LIBRO
CREATE OR REPLACE VIEW VI_Libros ( IDENTIFICADOR,LIBRO, AUTOR, AÑO, GENERO, EDITORIAL, IDIOMA) AS
SELECT  LIBRO.ID,LIBRO.NOMBRE, AUTOR.NOMBRE || ' ' || AUTOR.APELLIDO, LIBRO.ANIO, GENERO, EDITORIAL,IDIOMA
FROM AUTOR
JOIN COLABORACION ON AUTOR.ID = COLABORACION.COL_AUTOR_ID
JOIN LIBRO ON LIBRO.ID = COLABORACION.COL_LIBRO_ID
JOIN GENERO ON GENERO_ID = GENERO.ID
JOIN EDITORIAL ON EDITORIAL_ID = EDITORIAL.ID
JOIN IDIOMA ON IDIOMA_ID = IDIOMA.ID
order by LIBRO.ID;
--


--PROCEDIMIENTO PARA INSERTAR LIBRO
create or replace procedure insert_libro (nom_lib in VARCHAR2, nom_aut in VARCHAR2, ape_aut in VARCHAR2, an in NUMERIC, gen in VARCHAR2, edito in VARCHAR2, idiom in VARCHAR2)
as
    NEWID_LIBRO NUMERIC;
    NEWID_AUTOR NUMERIC;
    Begin
    SELECT MAX(COL_LIBRO_ID) INTO NEWID_LIBRO
    FROM COLABORACION;
    NEWID_LIBRO := NEWID_LIBRO + 1;
    ------------------------
    SELECT MAX(COL_AUTOR_ID) INTO NEWID_AUTOR
    FROM COLABORACION;
    NEWID_AUTOR := NEWID_AUTOR + 1;
    Insert into USR_PRESTAMO.LIBRO (LIBRO.ID,NOMBRE, ANIO, GENERO_ID , EDITORIAL_ID, IDIOMA_ID) values (NEWID_LIBRO,nom_lib,an, gen,edito,idiom);
    insert into USR_PRESTAMO.AUTOR (AUTOR.ID,NOMBRE, APELLIDO) values (NEWID_AUTOR, nom_aut, ape_aut);
    insert into USR_PRESTAMO.COLABORACION (COL_AUTOR_ID,COL_LIBRO_ID) values (NEWID_AUTOR, NEWID_LIBRO);
    End;
--

--PROCEDIMIENTO PARA EDITAR LIBRO
create or replace procedure editar_libro (newid_libro in NUMERIC,newid_autor in NUMERIC,nom_lib2 in VARCHAR2, nom_aut2 in VARCHAR2, ape_aut2 in VARCHAR2, an2 in NUMERIC, gen2 in VARCHAR2, edito2 in VARCHAR2, idiom2 in VARCHAR2)
as
    x_id_lib NUMBER := newid_libro;
    x_id_aut NUMBER := newid_autor;
    x_nom_lib VARCHAR2(50) := nom_lib2;
    x_nom_aut VARCHAR2(50) := nom_aut2;
    x_ape_aut VARCHAR2(50) := ape_aut2;
    x_an NUMBER := an2;
    x_gen VARCHAR2(50) := gen2;
    x_edito VARCHAR2(50) := edito2;
    x_idiom VARCHAR2(50) := idiom2;
    
    Begin
   update USR_PRESTAMO.LIBRO set NOMBRE = x_nom_lib, ANIO = x_an , GENERO_ID = x_gen , EDITORIAL_ID = x_edito, IDIOMA_ID = x_idiom where LIBRO.ID = x_id_lib;
   update USR_PRESTAMO.AUTOR set NOMBRE = x_nom_aut , APELLIDO = x_ape_aut where AUTOR.ID = x_id_aut;
   Exception
    when NO_DATA_FOUND then
    null;
    when others then
    raise;
    End editar_libro;
---   
--PROCEDIMIENTO PARA ELIMINAR LIBRO
create or replace procedure eliminar_libro (id_libro2 in NUMERIC,id_autor2 in NUMERIC)
as
 z_id_libro2 NUMBER := id_libro2;
 z_id_autor2 NUMBER := id_autor2;
 Begin
 delete from libro where LIBRO.ID = z_id_libro2;
 delete from autor where AUTOR.ID = z_id_autor2;
 delete from USR_PRESTAMO.COLABORACION where COL_AUTOR_ID = z_id_autor2 and COL_LIBRO_ID = z_id_libro2;
 end;
--